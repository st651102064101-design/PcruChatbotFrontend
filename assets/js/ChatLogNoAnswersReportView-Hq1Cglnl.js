import{r as e,g as a,P as t,c as l,o as s,d as n,p as o,D as r,n as i,y as u,I as d,e as c,l as p,H as v,i as m,t as g,a as b,F as h,b as f,u as y,z as w,L as k,f as C,h as L}from"./vue-vendor-CaqZERVf.js";import{_ as T,A as x,f as A,T as D,b as _,i as O,S,c as I,a as j}from"./index-CjxO0-0y.js";import{c as N,W as V}from"./dashboard-styles-CiicuUba.js";import"./auto-oB3XP6c3.js";/* empty css                                                                     */import{C as U,r as R}from"./chart-CicJT4lR.js";import"./axios-vendor-Dos3PyFQ.js";const E=["placeholder","value"],H=T({__name:"ReportSearch",props:{modelValue:{type:String,default:""},placeholder:{type:String,default:"ค้นหา..."},maxWidth:{type:String,default:"520px"},align:{type:String,default:"right"}},emits:["update:modelValue"],setup(d,{emit:c}){const p=c,v=e(null);function m(){p("update:modelValue",""),v.value?.focus()}function g(){p("update:modelValue",""),v.value?.blur()}function b(e){!e.ctrlKey&&!e.metaKey||"k"!==e.key&&"K"!==e.key||(e.preventDefault(),v.value?.focus()),"Escape"===e.key&&document.activeElement!==v.value&&p("update:modelValue","")}return a(()=>{window.addEventListener("keydown",b)}),t(()=>{window.removeEventListener("keydown",b)}),(e,a)=>(s(),l("div",{class:"report-search",style:u({maxWidth:d.maxWidth})},[n("div",{class:i(["apple-search-inner",{"align-right":"right"===d.align}])},[a[2]||(a[2]=n("div",{class:"search-icon-wrapper","aria-hidden":"true"},[n("i",{class:"bi bi-search"})],-1)),n("input",{ref_key:"inputEl",ref:v,placeholder:d.placeholder,class:"apple-search-input",value:d.modelValue,onInput:a[0]||(a[0]=a=>e.$emit("update:modelValue",a.target.value)),onKeydown:r(g,["esc"])},null,40,E),d.modelValue?(s(),l("button",{key:0,class:"search-clear-btn",onClick:m,"aria-label":"ล้างการค้นหา",title:"ล้าง"},[...a[1]||(a[1]=[n("i",{class:"bi bi-x-lg"},null,-1)])])):o("",!0)],2)],4))}},[["__scopeId","data-v-5ac02f34"]]),M={class:""},P={class:"card p-4 bg-light shadow-sm mb-4 rounded-4"},Q={class:"d-flex justify-content-between align-items-center mb-3"},F={key:0,class:"badge bg-success"},q={key:1,class:"badge bg-secondary"},W={key:0,class:"text-center py-3"},G={key:1,class:"alert alert-danger",role:"alert"},K={key:2},$={key:0,class:"row mb-3"},z={class:"col-lg-6"},B={class:"chart-container"},Z={class:"col-lg-6"},J={class:"chart-container"},Y={class:"d-flex justify-content-between align-items-center mb-2"},X={class:"small text-muted flex-grow-1 text-start"},ee={class:"search-wrapper"},ae={class:"table-responsive mt-3"},te={class:"table table-striped table-hover"},le={"data-label":"ID"},se={"data-label":"เวลา"},ne=["title"],oe={"data-label":"คำถาม"},re={key:0},ie={class:"d-flex justify-content-between align-items-center p-3 border-top mt-auto"},ue={class:"small text-muted"},de={"aria-label":"Page navigation for chatLogNoAnswers"},ce={class:"pagination pagination-sm mb-0 align-items-center"},pe=["onClick"],ve=T({__name:"ChatLogNoAnswersReport",props:{chartOptions:Object,barChartOptions:Object},setup(t){const{appContext:r}=d(),u=r.config.globalProperties.$axios;r.config.globalProperties.$swal;const C=e([]),L=e(!0),T=e(null),_=e(null),O=e(null);let S=null,I=null;const j=e(!1);let R=null;const E=e("");c(E,()=>{ye.value=1});const ve=e({sortBy:"date",sortOrder:"desc",datePreset:"all",dateFrom:"",dateTo:""}),me=[{value:"date",label:"วันที่"},{value:"id",label:"รหัส"},{value:"query",label:"คำถาม"}],ge=[{value:"all",label:"ทั้งหมด"},{value:"today",label:"วันนี้"},{value:"week",label:"7 วัน"},{value:"month",label:"30 วัน"}];function be(){ye.value=1}function he(e){if(!e)return"-";const a=new Date(e);return isNaN(a.getTime())?e:a.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"})}c(ve,()=>{ye.value=1},{deep:!0});const fe=async()=>{L.value=!0,T.value=null;try{const e=await u.get("/getChatLogNoAnswers");const a=(Array.isArray(e.data)?e.data:e.data?.data||e.data||[]).map(e=>{const a=e||{},t=a.ChatLogID??a.chatLogID??a.chatlogid??a.chat_log_id??a.id??null,l=a.Timestamp??a.timestamp??a.time??a.created_at??null,s=a.UserQuery??a.userQuery??a.user_query??a.query??a.message??"";return{...a,ChatLogID:t,Timestamp:l,UserQuery:s}});a.length,C.value=a}catch(e){T.value=e.response?.data?.message||e.message||"Failed to load data."}finally{L.value=!1}},ye=e(1),we=e(5),ke=p(()=>{let e=Array.isArray(C.value)?C.value:[];const a=ve.value,t=new Date,l=a.datePreset;let s=null;if(l&&"all"!==l)switch(l){case"today":s=new Date(t.getFullYear(),t.getMonth(),t.getDate());break;case"week":s=new Date(t.getTime()-6048e5);break;case"month":s=new Date(t.getTime()-2592e6)}if(s&&(s.setHours(0,0,0,0),e=e.filter(e=>!!e.Timestamp&&new Date(e.Timestamp)>=s)),a.dateFrom){const t=new Date(a.dateFrom);t.setHours(0,0,0,0),e=e.filter(e=>!!e.Timestamp&&new Date(e.Timestamp)>=t)}if(a.dateTo){const t=new Date(a.dateTo);t.setHours(23,59,59,999),e=e.filter(e=>!!e.Timestamp&&new Date(e.Timestamp)<=t)}const n=(E.value||"").toString().trim().toLowerCase();return n&&(e=e.filter(e=>{const a=null!=e.ChatLogID?String(e.ChatLogID).toLowerCase():"",t=e.UserQuery?String(e.UserQuery).toLowerCase():"";return a.includes(n)||t.includes(n)})),e}),Ce=p(()=>{const e=ke.value.slice(),{sortBy:a,sortOrder:t}=ve.value,l="asc"===t?1:-1;return e.sort((e,t)=>{let s=0;if("date"===a){s=(e?.Timestamp?new Date(e.Timestamp).getTime():0)-(t?.Timestamp?new Date(t.Timestamp).getTime():0)}else"id"===a?s=(e?.ChatLogID||0)-(t?.ChatLogID||0):"query"===a&&(s=(e?.UserQuery||"").localeCompare(t?.UserQuery||"","th"));return s*l})}),Le=p(()=>(Array.isArray(C.value)?C.value:[]).length),Te=p(()=>Ce.value.length),xe=p(()=>Math.max(1,Math.ceil(Te.value/we.value))),Ae=p(()=>0===Te.value?0:(ye.value-1)*we.value+1),De=p(()=>0===Te.value?0:Math.min(ye.value*we.value,Te.value)),_e=p(()=>{const e=(ye.value-1)*we.value;return Ce.value.slice(e,e+we.value)}),Oe=p(()=>{const e=xe.value,a=ye.value;return e<=4?Array.from({length:e},(e,a)=>a+1):a<=2?[1,2,3,4]:a>=e-1?[e-3,e-2,e-1,e]:[a-1,a,a+1,a+2]});function Se(e){e>=1&&e<=xe.value&&(ye.value=e)}function Ie(){Se(Math.max(1,ye.value-1))}function je(){Se(Math.min(xe.value,ye.value+1))}function Ne(){Se(1)}function Ve(){Se(xe.value)}const Ue=()=>{k(()=>{[...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map(e=>new D(e))})};c(_e,()=>{Ue()});const Re=p(()=>{const e={};(Array.isArray(C.value)?C.value:[]).forEach(a=>{const t=a.Timestamp;if(!t)return;const l=new Date(t);if(isNaN(l.getTime()))return;const s=l.toISOString().slice(0,10);e[s]=(e[s]||0)+1});const a=Object.keys(e).sort(),t=a.map(a=>e[a]);return{labels:a,values:t}}),Ee=p(()=>{const e={"เที่ยงคืน - รุ่งเช้า":0,"เช้า - เที่ยงวัน":0,"บ่าย - เย็น":0,"ค่ำ - กลางคืน":0};(Array.isArray(C.value)?C.value:[]).forEach(a=>{const t=a.Timestamp;if(!t)return;const l=new Date(t);if(isNaN(l.getTime()))return;const s=l.getHours();s>=0&&s<=5?e["เที่ยงคืน - รุ่งเช้า"]++:s>=6&&s<=11?e["เช้า - เที่ยงวัน"]++:s>=12&&s<=17?e["บ่าย - เย็น"]++:e["ค่ำ - กลางคืน"]++});const a=Object.keys(e),t=a.map(a=>e[a]);return{labels:a,data:t}}),He=p(()=>{const{labels:e,data:a}=Ee.value,t=["#007bff","#28A745","#FFC107","#6c757d"];return{labels:e,datasets:[{data:a,backgroundColor:e.map((e,a)=>t[a%t.length])}]}}),Me=p(()=>{const{labels:e,values:a}=Re.value;return{labels:e,datasets:[{label:"Messages per Day",data:a,borderColor:"#007bff",backgroundColor:"rgba(0, 123, 255, 0.1)",fill:!0,tension:.4}]}});return c(C,()=>{!L.value&&!T.value&&C.value.length>0&&(S&&(S.destroy(),S=null),I&&(I.destroy(),I=null),k(()=>{_.value&&He.value&&(S=new U(_.value,{type:"polarArea",data:He.value,options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})),O.value&&Me.value&&(I=new U(O.value,{type:"line",data:Me.value,options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{precision:0}}}}}))}))},{deep:!0}),a(()=>{fe(),Ue(),R=N(V.CHAT_LOGS,{axios:u,onMessage:e=>{const a=e?.data?.action||e?.action||"",t=e?.type||"";(a||"CHATLOG_UPDATE"===t||"CHATLOGS_UPDATE"===t)&&fe()},onOpen:()=>{j.value=!0},onClose:()=>{j.value=!1}})}),v(()=>{R&&R.disconnect(),S&&S.destroy(),I&&I.destroy()}),(e,a)=>(s(),l("div",M,[n("div",P,[n("div",Q,[a[4]||(a[4]=n("h3",{class:"fs-5 mb-0"},"ChatLogNoAnswers Report",-1)),j.value?(s(),l("span",F,[...a[2]||(a[2]=[n("i",{class:"bi bi-wifi"},null,-1),m(" Live ",-1)])])):(s(),l("span",q,[...a[3]||(a[3]=[n("i",{class:"bi bi-wifi-off"},null,-1),m(" Offline ",-1)])]))]),a[8]||(a[8]=n("div",{class:"alert alert-warning alert-dismissible fade show py-2 px-3 small",role:"alert"},[n("i",{class:"bi bi-info-circle me-1"}),n("strong",null,"หมายเหตุ:"),m(" ข้อมูลจะถูกลบอัตโนมัติหลังจากจัดเก็บครบ 30 วัน (คำนวณจากวันที่บันทึก) "),n("button",{type:"button",class:"btn-close btn-close-sm","data-bs-dismiss":"alert","aria-label":"Close"})],-1)),L.value?(s(),l("div",W,[...a[5]||(a[5]=[n("div",{class:"spinner-border text-primary",role:"status"},[n("span",{class:"visually-hidden"},"Loading...")],-1),n("p",{class:"mt-2"},"Loading ChatLogNoAnswers data...",-1)])])):T.value?(s(),l("div",G,"Error: "+g(T.value),1)):(s(),l("div",K,[Le.value>0?(s(),l("div",$,[n("div",z,[n("div",B,[n("canvas",{ref_key:"pieCanvas",ref:_},null,512)])]),n("div",Z,[n("div",J,[n("canvas",{ref_key:"barCanvas",ref:O},null,512)])])])):o("",!0),n("div",Y,[n("div",X,"Total: "+g(Te.value),1),n("div",ee,[b(H,{modelValue:E.value,"onUpdate:modelValue":a[0]||(a[0]=e=>E.value=e),placeholder:"ค้นหา chatlog..."},null,8,["modelValue"])])]),b(x,{modelValue:ve.value,"onUpdate:modelValue":a[1]||(a[1]=e=>ve.value=e),"show-sort":!0,"sort-options":me,"default-sort-by":"date","default-sort-order":"desc","show-date-presets":!0,"custom-date-presets":ge,"show-date-range":!0,onChange:be},null,8,["modelValue"]),n("div",ae,[n("table",te,[a[7]||(a[7]=n("thead",null,[n("tr",null,[n("th",null,"ChatLogID"),n("th",null,"Timestamp"),n("th",null,"UserQuery")])],-1)),n("tbody",null,[(s(!0),l(h,null,f(_e.value,e=>(s(),l("tr",{key:e.ChatLogID},[n("td",le,g(e.ChatLogID),1),n("td",se,[n("span",{class:"badge bg-secondary","data-bs-toggle":"tooltip","data-bs-placement":"top",title:he(e.Timestamp)},g(y(A)(e.Timestamp)),9,ne)]),n("td",oe,g(e.UserQuery||"-"),1)]))),128)),0===ke.value.length?(s(),l("tr",re,[...a[6]||(a[6]=[n("td",{colspan:"3",class:"text-center text-muted py-3"},"No ChatLogNoAnswers data found",-1)])])):o("",!0)])]),n("div",ie,[n("div",ue,"Showing "+g(Ae.value)+" to "+g(De.value)+" of "+g(Te.value)+" entries",1),n("nav",de,[n("ul",ce,[n("li",{class:i(["page-item",{disabled:1===ye.value}])},[n("a",{class:"page-link",href:"#",onClick:w(Ne,["prevent"])},"«")],2),n("li",{class:i(["page-item",{disabled:1===ye.value}])},[n("a",{class:"page-link",href:"#",onClick:w(Ie,["prevent"])},"‹")],2),(s(!0),l(h,null,f(Oe.value,e=>(s(),l("li",{key:e,class:i(["page-item",{active:ye.value===e}])},[n("a",{class:"page-link",href:"#",onClick:w(a=>Se(e),["prevent"])},g(e),9,pe)],2))),128)),n("li",{class:i(["page-item",{disabled:ye.value===xe.value||0===xe.value}])},[n("a",{class:"page-link",href:"#",onClick:w(je,["prevent"])},"›")],2),n("li",{class:i(["page-item",{disabled:ye.value===xe.value||0===xe.value}])},[n("a",{class:"page-link",href:"#",onClick:w(Ve,["prevent"])},"»")],2)])])])])]))])]))}},[["__scopeId","data-v-dc9b6d8e"]]),me={class:"report-page-container"},ge={class:"main-content flex-grow-1"},be={class:"apple-dashboard"},he={class:"dashboard-hero fade-in-up"},fe={class:"hero-content"},ye=["aria-label"],we={class:"hero-status"},ke={class:"reports-grid px-4 pb-5 fade-in-up",style:{"animation-delay":"0.1s"}},Ce=T({__name:"ChatLogNoAnswersReportView",setup(t){U.register(...R);const r=C(),{appContext:u}=d(),{$axios:c}=u.config.globalProperties,p=e({}),m=e(""),h=e(!1);let f=null,k=null;const T=()=>{const e=document.querySelector(".sidebar");!O.value?(k=j.value,j.value=!1,e&&e.classList.remove("collapsed"),document.body.classList.add("sidebar-open"),document.body.classList.add("sidebar-mobile-expanded"),O.value=!0):(j.value=!!k,e&&k&&e.classList.add("collapsed"),document.body.classList.remove("sidebar-open"),document.body.classList.remove("sidebar-mobile-expanded"),O.value=!1,k=null)},x=e({responsive:!0,maintainAspectRatio:!1,cutout:"70%",plugins:{legend:{position:"right",labels:{usePointStyle:!0,boxWidth:8,font:{family:"-apple-system, sans-serif"}}},tooltip:{cornerRadius:12,padding:12,backgroundColor:"rgba(0,0,0,0.8)"}}}),A=e({responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,grid:{borderDash:[4,4],color:"#f0f0f0"},ticks:{font:{family:"-apple-system, sans-serif"}}},x:{grid:{display:!1},ticks:{font:{family:"-apple-system, sans-serif"}}}},borderRadius:6,barThickness:24}),D=e=>{h.value=e};let E=null;return a(()=>{E=_();const e=localStorage.getItem("userToken"),a=localStorage.getItem("userType"),t=localStorage.getItem("userInfo");if(e){if(a&&(m.value=a),t)try{p.value=JSON.parse(t)}catch(l){}f=N(V.CHAT_LOGS,{axios:c,onOpen:()=>{h.value=!0},onClose:()=>{h.value=!1}})}else r.replace({name:"login"})}),v(()=>{f&&f.disconnect(),"function"==typeof E&&E(),O.value=!1,document.body.classList.remove("sidebar-open"),document.body.classList.remove("sidebar-mobile-expanded")}),(e,a)=>(s(),l("div",me,[b(S,{userType:m.value,userInfoObject:p.value},null,8,["userType","userInfoObject"]),y(O)?(s(),l("div",{key:0,class:"mobile-sidebar-backdrop",onClick:T,"aria-hidden":"true"})):o("",!0),n("main",ge,[n("div",be,[n("div",he,[n("div",fe,[n("button",{class:"mobile-sidebar-toggle mobile-inline-toggle",onClick:w(T,["stop"]),"aria-label":y(O)?"Close sidebar":"Open sidebar"},[b(I,{isOpen:y(O)},null,8,["isOpen"])],8,ye),a[0]||(a[0]=L('<div class="hero-heading d-flex align-items-center gap-3" data-v-3dd0b93f><div class="apple-icon-box orange-gradient" data-v-3dd0b93f><svg class="chat-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" data-v-3dd0b93f><path class="chat-bubble" d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" data-v-3dd0b93f></path><path class="question-mark" d="M12 7v2m0 4h.01" data-v-3dd0b93f></path></svg></div><div data-v-3dd0b93f><h1 class="hero-title" data-v-3dd0b93f>ChatLog No Answers</h1><p class="hero-subtitle" data-v-3dd0b93f>รายงานการสนทนาที่ไม่มีคำตอบจากระบบ</p></div></div>',1))]),n("div",we,[n("div",{class:i(["apple-status-badge",{online:h.value}])},[a[1]||(a[1]=n("span",{class:"status-dot"},null,-1)),n("span",null,g(h.value?"Live":"Offline"),1)],2)])]),n("div",ke,[b(ve,{chartOptions:x.value,barChartOptions:A.value,onWsStatus:D},null,8,["chartOptions","barChartOptions"])])])])]))}},[["__scopeId","data-v-3dd0b93f"]]);export{Ce as default};
