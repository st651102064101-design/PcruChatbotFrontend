import{f as e,I as a,r as l,g as s,H as t,e as i,L as n,l as c,c as d,o,a as r,p as u,d as v,m as p,u as b,h as m,z as y,i as f,n as h,t as g,s as k,G as w,F as x,b as F,w as C,q as A,x as D}from"./vue-vendor-CaqZERVf.js";import{D as T,B as I}from"./index-DlWMEZ1A.js";import{C as j,r as L}from"./chart-CicJT4lR.js";import{c as S,W as R}from"./dashboard-styles-DF6dX7li.js";import{_ as O,b as U,i as _,T as E,S as H,c as V,A as B,a as Q,f as M}from"./index-YNQFrYK5.js";import"./axios-vendor-Dos3PyFQ.js";const P={class:"dashboard-container"},q={class:"main-content"},W={class:"container-fluid pt-2 px-4 pb-5"},z={class:"d-flex align-items-center justify-content-between mb-4 fade-in-up"},$={class:"d-flex align-items-center gap-3"},G=["aria-label"],J={class:"d-flex align-items-center gap-2"},K={key:0,class:"text-center py-5 fade-in"},N={key:1,class:"alert apple-alert-danger mx-auto",role:"alert"},Z={key:2,class:"fade-in-up",style:{"animation-delay":"0.1s"}},X={class:"row mb-4 g-3"},Y={class:"col-12"},ee={class:"apple-stat-card"},ae={class:"stat-content"},le={class:"stat-value"},se={key:0,class:"row mb-4 g-4"},te={class:"col-12 col-lg-6"},ie={class:"apple-card chart-card h-100"},ne={class:"chart-area w-100"},ce={class:"chart-wrapper"},de={class:"col-12 col-lg-6"},oe={class:"apple-card chart-card h-100"},re={class:"chart-area w-100"},ue={class:"chart-wrapper"},ve={class:"apple-card table-wrapper"},pe={class:"card-header-actions p-3 d-flex justify-content-between align-items-center"},be={class:"apple-counter-capsule"},me={class:"count"},ye={class:"search-container"},fe={class:"table-responsive"},he={class:"table apple-table mb-0"},ge=["onClick"],ke={"data-label":"ID",class:"ps-4 fw-medium text-secondary"},we={"data-label":"วันที่",class:"py-3"},xe=["title"],Fe={"data-label":"คำถาม",class:"py-3"},Ce=["title"],Ae={"data-label":"เหตุผล",class:"py-3"},De={key:0,class:"d-flex align-items-center gap-2 flex-wrap"},Te={class:"reason-tag"},Ie=["title"],je={key:1,class:"text-muted small opacity-50"},Le={key:0},Se={class:"d-flex justify-content-between align-items-center p-3 border-top bg-white rounded-bottom-4"},Re={class:"small text-secondary"},Oe={"aria-label":"Page navigation"},Ue={class:"pagination pagination-sm mb-0 align-items-center"},_e=["onClick"],Ee={class:"apple-modal-content"},He={class:"apple-modal-header"},Ve={class:"d-flex flex-column"},Be={class:"apple-modal-subtitle"},Qe={class:"apple-modal-body"},Me={class:"detail-section"},Pe={class:"detail-value text-dark fw-medium"},qe={class:"detail-section"},We={class:"detail-value text-primary"},ze={class:"row g-3 mb-3"},$e={class:"col-6"},Ge={class:"detail-section"},Je={class:"detail-value"},Ke={class:"detail-section"},Ne={class:"detail-value bg-light p-3 rounded-3 border-0 text-secondary"},Ze={class:"detail-section mt-4 pt-3 border-top"},Xe={class:"d-flex align-items-center justify-content-between text-secondary small"},Ye={class:"apple-modal-footer"},ea=["disabled"],aa={key:0,class:"spinner-border spinner-border-sm me-2"},la={key:1,class:"bi bi-arrow-counterclockwise me-2"},sa=O({__name:"HandledFeedbacksReportView",setup(O){j.register(...L);const sa=e(),{appContext:ta}=a(),ia=ta.config.globalProperties.$axios,na=l({}),ca=l("");let da=null,oa=null;const ra=()=>{const e=document.querySelector(".sidebar");!_.value?(oa=Q.value,Q.value=!1,e&&e.classList.remove("collapsed"),document.body.classList.add("sidebar-open"),document.body.classList.add("sidebar-mobile-expanded"),_.value=!0):(Q.value=!!oa,e&&oa&&e.classList.add("collapsed"),document.body.classList.remove("sidebar-open"),document.body.classList.remove("sidebar-mobile-expanded"),_.value=!1,oa=null)},ua=l([]),va=l(!0),pa=l(null),ba=l(""),ma=l(!1),ya=l(null);let fa=null;const ha=l({sortBy:"date",sortOrder:"desc",status:"",datePreset:"all",dateFrom:"",dateTo:""}),ga=[{value:"date",label:"วันที่"},{value:"id",label:"รหัส"},{value:"reason",label:"เหตุผล"}],ka=[{value:"all",label:"ทั้งหมด"},{value:"today",label:"วันนี้"},{value:"week",label:"7 วัน"},{value:"month",label:"30 วัน"}];function wa(){Ca.value=1}const xa=l(!1),Fa=l(null),Ca=l(1),Aa=l(5),Da=["#34C759","#FF3B30","#007AFF","#FF9500","#AF52DE","#5856D6"];s(()=>{da=U();const e=localStorage.getItem("userToken"),a=localStorage.getItem("userType"),l=localStorage.getItem("userInfo");if(e){if(a&&(ca.value=a),l)try{na.value=JSON.parse(l)}catch(s){}_.value=!1,document.body.classList.remove("sidebar-open"),document.body.classList.remove("sidebar-mobile-expanded"),Ta(),fa=S(R.FEEDBACKS,{axios:ia,onMessage:e=>{(e?.type?.includes("UPDATE")||e?.action?.includes("handle"))&&Ta()},onOpen:()=>{ma.value=!0},onClose:()=>{ma.value=!1}})}else sa.replace({name:"login"})}),t(()=>{fa&&fa.disconnect(),"function"==typeof da&&da(),_.value=!1,document.body.classList.remove("sidebar-open"),document.body.classList.remove("sidebar-mobile-expanded")}),i(ba,()=>{Ca.value=1}),i(ua,()=>{n(()=>Za())}),i(ha,()=>{Ca.value=1},{deep:!0});const Ta=async()=>{va.value=!0,pa.value=null;try{const e=await ia.get("/feedbacks/handled"),a=e.data?.data??e.data;Array.isArray(a)?ua.value=a:a&&"object"==typeof a&&Array.isArray(a.rows)?ua.value=a.rows:a&&"object"==typeof a&&a.success&&Array.isArray(a.data)?ua.value=a.data:ua.value=[]}catch(e){ua.value=[],pa.value="Failed to load history."}finally{va.value=!1,n(()=>Za())}},Ia=c(()=>{let e=Array.isArray(ua.value)?ua.value:[];if(e=e.filter(e=>!La(e)),ha.value.dateFrom){const a=new Date(ha.value.dateFrom);a.setHours(0,0,0,0),e=e.filter(e=>!!e.Timestamp&&new Date(e.Timestamp)>=a)}if(ha.value.dateTo){const a=new Date(ha.value.dateTo);a.setHours(23,59,59,999),e=e.filter(e=>!!e.Timestamp&&new Date(e.Timestamp)<=a)}const a=(ba.value||"").toLowerCase().trim();return a&&(e=e.filter(e=>String(e.UserQuery||"").toLowerCase().includes(a)||String(e.FeedbackComment||"").toLowerCase().includes(a)||String(e.FeedbackReason||"").toLowerCase().includes(a))),e}),ja=c(()=>{const e=Ia.value.slice(),{sortBy:a,sortOrder:l}=ha.value,s="asc"===l?1:-1;return e.sort((e,l)=>{let t=0;if("date"===a){t=(e?.Timestamp?new Date(e.Timestamp).getTime():0)-(l?.Timestamp?new Date(l.Timestamp).getTime():0)}else"id"===a?t=(e?.FeedbackID||0)-(l?.FeedbackID||0):"reason"===a&&(t=(e?.FeedbackReason||"").localeCompare(l?.FeedbackReason||"","th"));return t*s})});function La(e){return 1===e?.FeedbackValue||!0===e?.FeedbackValue}const Sa=c(()=>Ia.value.length);c(()=>Array.isArray(Ia.value)?Ia.value.filter(e=>La(e)).length:0),c(()=>Array.isArray(Ia.value)?Ia.value.filter(e=>!La(e)).length:0);const Ra=c(()=>Sa.value>0),Oa=c(()=>{const e=Array.isArray(Ia.value)?Ia.value:[],a={};return e.forEach(e=>{if(e&&e.FeedbackReason){const l=Ja(e.FeedbackReason);a[l]=(a[l]||0)+1}}),{labels:Object.keys(a),datasets:[{data:Object.values(a),backgroundColor:Da,borderWidth:0}]}}),Ua=c(()=>{const e=Array.isArray(Ia.value)?Ia.value:[],a={};e.forEach(e=>{if(e&&e.Timestamp){const l=String(e.Timestamp).split("T")[0];a[l]=(a[l]||0)+1}});const l=Object.keys(a).sort().slice(-7),s=l.map(e=>a[e]||0);return{labels:l,datasets:[{label:"Handled Feedbacks",data:s,backgroundColor:"#34C759",borderRadius:4,barThickness:20}]}}),_a={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{usePointStyle:!0,boxWidth:8}}},cutout:"70%"},Ea={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,grid:{borderDash:[4,4],color:"#f0f0f0"},ticks:{precision:0}},x:{grid:{display:!1}}}},Ha=c(()=>Math.ceil(Sa.value/Aa.value)||1),Va=c(()=>(Ca.value-1)*Aa.value+1),Ba=c(()=>Math.min(Ca.value*Aa.value,Sa.value)),Qa=c(()=>{const e=Array.isArray(ja.value)?ja.value:[],a=(Ca.value-1)*Aa.value;return e.slice(a,a+Aa.value)}),Ma=c(()=>{const e=Ha.value,a=Ca.value;return e<=5?Array.from({length:e},(e,a)=>a+1):a<=3?[1,2,3,4,5]:a>=e-2?[e-4,e-3,e-2,e-1,e]:[a-1,a,a+1,a+2]});function Pa(e){e>=1&&e<=Ha.value&&(Ca.value=e)}function qa(){Pa(Ca.value-1)}function Wa(){Pa(Ca.value+1)}function za(){Pa(1)}function $a(){Pa(Ha.value)}function Ga(e){return e?new Date(e).toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}):"-"}function Ja(e){return{wrong_answer:"คำตอบไม่ถูกต้อง",incomplete:"ข้อมูลไม่ครบ",outdated:"ข้อมูลล้าสมัย",not_relevant:"ไม่เกี่ยวข้อง",confusing:"สับสน/เข้าใจยาก",other:"อื่นๆ"}[e]||e||"-"}function Ka(){xa.value=!1}async function Na(e){const a=await async function(e){if(e?.FeedbackID){ya.value=e.FeedbackID;try{return await ia.put(`/feedbacks/${e.FeedbackID}/unhandle`),ua.value=ua.value.filter(a=>a.FeedbackID!==e.FeedbackID),!0}catch(a){return alert("กู้คืนไม่สำเร็จ"),!1}finally{ya.value=null}}}(e);a&&Ka()}function Za(){n(()=>{document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>new E(e))})}return(e,a)=>(o(),d("div",P,[r(H,{userType:ca.value,userInfoObject:na.value},null,8,["userType","userInfoObject"]),b(_)?(o(),d("div",{key:0,class:"mobile-sidebar-backdrop",onClick:ra,"aria-hidden":"true"})):u("",!0),v("main",q,[v("div",W,[v("div",z,[v("div",$,[v("button",{class:"mobile-sidebar-toggle mobile-inline-toggle",onClick:y(ra,["stop"]),"aria-label":b(_)?"Close sidebar":"Open sidebar"},[r(V,{isOpen:b(_)},null,8,["isOpen"])],8,G),a[4]||(a[4]=m('<div class="apple-icon-box green-gradient" data-v-9fdbada8><svg class="check-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" data-v-9fdbada8><path class="check-path" d="M20 6L9 17l-5-5" data-v-9fdbada8></path></svg></div><div data-v-9fdbada8><h3 class="page-title m-0" data-v-9fdbada8>Handled Feedbacks</h3><span class="text-secondary small" data-v-9fdbada8>ประวัติ Feedback ที่ตรวจสอบแล้ว</span></div>',2))]),a[6]||(a[6]=v("div",{class:"auto-delete-notice"},[v("i",{class:"bi bi-info-circle-fill"}),v("span",null,[f("ระบบจะลบ Feedback ที่จัดการแล้วโดยอัตโนมัติหลังจาก "),v("strong",null,"30 วัน")])],-1)),v("div",J,[v("div",{class:h(["apple-status-badge",{online:ma.value}])},[a[5]||(a[5]=v("span",{class:"status-dot"},null,-1)),v("span",null,g(ma.value?"Live":"Offline"),1)],2)])]),va.value?(o(),d("div",K,[...a[7]||(a[7]=[v("div",{class:"apple-spinner"},null,-1),v("p",{class:"mt-3 text-secondary"},"กำลังโหลดข้อมูล...",-1)])])):pa.value?(o(),d("div",N,[a[8]||(a[8]=v("i",{class:"bi bi-exclamation-circle-fill me-2"},null,-1)),f(" "+g(pa.value),1)])):(o(),d("div",Z,[v("div",X,[v("div",Y,[v("div",ee,[a[10]||(a[10]=v("div",{class:"stat-icon-wrapper green-gradient"},[v("i",{class:"bi bi-check2-circle"})],-1)),v("div",ae,[v("div",le,g(Sa.value),1),a[9]||(a[9]=v("div",{class:"stat-label"},"จัดการแล้วทั้งหมด",-1))])])])]),Ra.value?(o(),d("div",se,[v("div",te,[v("div",ie,[a[11]||(a[11]=v("div",{class:"card-header-clean"},[v("h5",null,"สัดส่วนปัญหา (Reasons)")],-1)),v("div",ne,[v("div",ce,[r(b(T),{"chart-data":Oa.value,"chart-options":_a,style:{height:"260px"}},null,8,["chart-data"])])])])]),v("div",de,[v("div",oe,[a[12]||(a[12]=v("div",{class:"card-header-clean"},[v("h5",null,"กิจกรรมย้อนหลัง (Activity)")],-1)),v("div",re,[v("div",ue,[r(b(I),{"chart-data":Ua.value,"chart-options":Ea,style:{height:"260px"}},null,8,["chart-data"])])])])])])):u("",!0),v("div",ve,[v("div",pe,[v("div",be,[a[13]||(a[13]=v("span",{class:"label"},"Total",-1)),a[14]||(a[14]=v("span",{class:"separator"},"|",-1)),v("span",me,g(Sa.value),1)]),v("div",ye,[a[16]||(a[16]=v("i",{class:"bi bi-search search-icon"},null,-1)),k(v("input",{type:"text",class:"search-input",placeholder:"ค้นหา...","onUpdate:modelValue":a[0]||(a[0]=e=>ba.value=e)},null,512),[[w,ba.value]]),ba.value?(o(),d("button",{key:0,class:"search-clear",onClick:a[1]||(a[1]=e=>ba.value="")},[...a[15]||(a[15]=[v("i",{class:"bi bi-x-circle-fill"},null,-1)])])):u("",!0)])]),r(B,{modelValue:ha.value,"onUpdate:modelValue":a[2]||(a[2]=e=>ha.value=e),"show-sort":!0,"sort-options":ga,"default-sort-by":"date","default-sort-order":"desc","show-date-presets":!0,"custom-date-presets":ka,"show-date-range":!0,onChange:wa},null,8,["modelValue"]),v("div",fe,[v("table",he,[a[19]||(a[19]=v("thead",null,[v("tr",null,[v("th",{class:"ps-4",style:{width:"80px"}},"ID"),v("th",{style:{width:"120px"}},"สถานะ"),v("th",null,"วันที่"),v("th",null,"คำถามผู้ใช้"),v("th",null,"เหตุผล & ความเห็น")])],-1)),v("tbody",null,[(o(!0),d(x,null,F(Qa.value,e=>(o(),d("tr",{key:e.FeedbackID,class:"align-middle apple-row",onClick:a=>function(e){Fa.value=e,xa.value=!0}(e)},[v("td",ke,g(e.FeedbackID),1),a[17]||(a[17]=v("td",{"data-label":"สถานะ",class:"py-3"},[v("span",{class:"feedback-pill unlike"},[v("i",{class:"bi bi-hand-thumbs-down-fill me-1"}),f(" Unlike ")])],-1)),v("td",we,[v("span",{class:"apple-badge-gray","data-bs-toggle":"tooltip","data-bs-placement":"top",title:Ga(e.Timestamp)},g(b(M)(e.Timestamp)),9,xe)]),v("td",Fe,[v("div",{class:"text-dark fw-medium text-truncate",style:{"max-width":"250px"},title:e.UserQuery},g(e.UserQuery||"-"),9,Ce)]),v("td",Ae,[e.FeedbackReason?(o(),d("div",De,[v("span",Te,g(Ja(e.FeedbackReason)),1),e.FeedbackComment?(o(),d("span",{key:0,class:"text-secondary small text-truncate",style:{"max-width":"150px"},title:e.FeedbackComment}," — "+g(e.FeedbackComment),9,Ie)):u("",!0)])):(o(),d("span",je,"-"))])],8,ge))),128)),0===Ia.value.length?(o(),d("tr",Le,[...a[18]||(a[18]=[v("td",{colspan:"6",class:"text-center text-muted py-5"},[v("div",{class:"empty-state"},[v("i",{class:"bi bi-folder-check fs-1 mb-2 opacity-50"}),v("p",null,"ไม่พบรายการที่ค้นหา")])],-1)])])):u("",!0)])])]),v("div",Se,[v("div",Re," แสดง "+g(Va.value)+" - "+g(Ba.value)+" จาก "+g(Sa.value)+" รายการ ",1),v("nav",Oe,[v("ul",Ue,[v("li",{class:h(["page-item",{disabled:1===Ca.value}])},[v("a",{class:"page-link",href:"#",onClick:y(za,["prevent"])},"«")],2),v("li",{class:h(["page-item",{disabled:1===Ca.value}])},[v("a",{class:"page-link",href:"#",onClick:y(qa,["prevent"])},"‹")],2),(o(!0),d(x,null,F(Ma.value,e=>(o(),d("li",{key:e,class:h(["page-item",{active:Ca.value===e}])},[v("a",{class:"page-link page-num",href:"#",onClick:y(a=>Pa(e),["prevent"])},g(e),9,_e)],2))),128)),v("li",{class:h(["page-item",{disabled:Ca.value===Ha.value||0===Ha.value}])},[v("a",{class:"page-link",href:"#",onClick:y(Wa,["prevent"])},"›")],2),v("li",{class:h(["page-item",{disabled:Ca.value===Ha.value||0===Ha.value}])},[v("a",{class:"page-link",href:"#",onClick:y($a,["prevent"])},"»")],2)])])])])]))])]),(o(),p(D,{to:"body"},[r(A,{name:"apple-zoom"},{default:C(()=>[xa.value?(o(),d("div",{key:0,class:"apple-modal-overlay",onClick:y(Ka,["self"])},[v("div",Ee,[v("div",He,[v("div",Ve,[a[20]||(a[20]=v("h5",{class:"apple-modal-title"},"รายละเอียด Feedback",-1)),v("span",Be,"ID: "+g(Fa.value?.FeedbackID),1)]),v("button",{class:"apple-close-btn",onClick:Ka},[...a[21]||(a[21]=[v("i",{class:"bi bi-x-lg"},null,-1)])])]),v("div",Qe,[v("div",Me,[a[22]||(a[22]=v("label",null,"คำถามจากผู้ใช้ (User Query)",-1)),v("div",Pe,g(Fa.value?.UserQuery||"-"),1)]),v("div",qe,[a[24]||(a[24]=v("label",null,"คำตอบที่ระบบจับคู่ (Matched Answer)",-1)),v("div",We,[a[23]||(a[23]=v("i",{class:"bi bi-arrow-return-right me-2"},null,-1)),f(g(Fa.value?.QuestionText||"-"),1)])]),v("div",ze,[a[26]||(a[26]=v("div",{class:"col-6"},[v("div",{class:"detail-section"},[v("label",null,"สถานะ (Status)"),v("div",null,[v("span",{class:"feedback-pill unlike"},[v("i",{class:"bi bi-hand-thumbs-down-fill me-1"}),f(" Unlike ")])])])],-1)),v("div",$e,[v("div",Ge,[a[25]||(a[25]=v("label",null,"เหตุผล (Reason)",-1)),v("div",Je,g(Ja(Fa.value?.FeedbackReason)),1)])])]),v("div",Ke,[a[27]||(a[27]=v("label",null,"ความคิดเห็น (Comment)",-1)),v("div",Ne,g(Fa.value?.FeedbackComment||"ไม่มีความคิดเห็นเพิ่มเติม"),1)]),v("div",Ze,[v("div",Xe,[v("span",null,[a[28]||(a[28]=v("i",{class:"bi bi-clock me-1"},null,-1)),f(" บันทึกเมื่อ: "+g(Ga(Fa.value?.Timestamp)),1)]),a[29]||(a[29]=v("span",{class:"text-success fw-medium"},[v("i",{class:"bi bi-check-circle-fill me-1"}),f(" ดำเนินการแล้ว")],-1))])])]),v("div",Ye,[v("button",{class:"btn-apple-secondary",onClick:Ka},"ปิดหน้าต่าง"),v("button",{class:"btn-apple-primary",onClick:a[3]||(a[3]=e=>Na(Fa.value)),disabled:ya.value===Fa.value?.FeedbackID},[ya.value===Fa.value?.FeedbackID?(o(),d("span",aa)):(o(),d("i",la)),a[30]||(a[30]=f(" กู้คืน Feedback ",-1))],8,ea)])])])):u("",!0)]),_:1})]))]))}},[["__scopeId","data-v-9fdbada8"]]);export{sa as default};
